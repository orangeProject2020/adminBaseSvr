exports.ids=[3],exports.modules={95:function(e,t,l){"use strict";l.r(t);var o=l(88),n=l.n(o),c=l(8),r={data(){return{fileObject:{},fileMd5CheckProcess:"",fileMd5:"",fileExt:"",chunkSize:5e5,chunks:0,currentChunk:0,isUploading:!1,accpetTypeRule:this.accpetTypeLimit,accpetTypes:{"application/zip":"zip","image/jpeg":"jpg","image/png":"png","video/mp4":"mp4"},uploadStep:0,uploadError:""}},props:{accpetTypeLimit:{type:String,default:"mp4|jpg|png",required:!1}},computed:{id:()=>"uploader_"+parseInt(1e7*Math.random())},methods:{chooseFile(){this.isUploading?this.$alert("上传中。。。"):this.$refs.fileInput.click()},checkFileType(e){let t=e.type;if(t){if(!(Object.keys(this.accpetTypes).indexOf(t)>-1))return this.fileExt="",this.$alert("不支持的文件类型"),!1;this.fileExt=this.accpetTypes[t]}else this.fileExt=e.name.match(/\.(\w+)$/)[1];return this.accpetTypeRule.indexOf(this.fileExt)<0?(this.$alert("不支持的文件类型"),!1):(console.log("checkFileType ext:",this.fileExt),!0)},readFileMd5(e){console.log("readFileMd5 start .....");let t=this,l=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,o=Math.ceil(e.size/t.chunkSize);console.log("readFileMd5 chunks:",o),this.chunks=o,this.currentChunk=0,this.fileMd5="",this.uploadStep=0,this.uploadError="";let c=new n.a.ArrayBuffer,r=new FileReader;return new Promise((n,d)=>{r.onload=function(e){t.fileMd5CheckProcess=t.currentChunk+1+"/"+o,console.log("readFileMd5 read chunk nr",t.currentChunk+1,"/",o);let l=e.target.result;if(c.append(l),t.currentChunk++,t.currentChunk<o)h();else{let e=c.end();console.info("readFileMd5 computed hash:",e),console.log("readFileMd5 end ....."),n(e)}},r.onerror=function(){console.log("readFileMd5 fail ....."),n(null)};let h=()=>{let o=t.currentChunk*t.chunkSize,n=o+t.chunkSize>=e.size?e.size:o+t.chunkSize;r.readAsArrayBuffer(l.call(e,o,n))};h()})},async getFileUploadedInfo(e){let t=await c.a.post("/api/utils/file/getItem",{md5:e});return console.log("getFileUploadedInfo ret",t),0===t.code&&t.data?this.uploadStep=t.data.step||0:this.uploadStep=0,this.uploadStep==this.chunks&&this.$emit("uploadSuccess",{md5:this.fileMd5}),console.log("getFileUploadedInfo this.uploadStep:",this.uploadStep),t},fileSliceAction(e,t=0,l){let o=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice,n=t*this.chunkSize,c=n+this.chunkSize>=e.size?e.size:n+this.chunkSize;return o.call(e,n,c)},async uploadFileSlice(){console.log("uploadFileSlice start ...");let e=this.uploadStep||0,t=this.fileObject;console.log("uploadFileSlice file:",t),this.isUploading=!0;try{let l={md5:this.fileMd5,size:t.size,type:t.type,ext:this.fileExt,step:e,chunks:this.chunks};for(let o=e;o<this.chunks;o++){console.log("uploadFileSlice step:",e);let n=this.fileSliceAction(t,e);console.log("uploadFileSlice slice",n),l.step=o,this.uploadStep=o;let c=await this.uploadFileRequest(n,l);console.log("uploadFileSlice step retUp",e,c);let r=c?JSON.parse(c):{};if(console.log("uploadFileSlice step retUpJson",e,r),0!=r.code)throw new Error(r.message||"未知错误")}return this.uploadStep+=1,this.isUploading=!1,this.$emit("uploadSuccess",{md5:this.fileMd5}),!0}catch(e){return this.uploadError=e.message||e,null}},uploadFileRequest:(e,t)=>(console.log("uploadFileRequest params",t),new Promise((l,o)=>{var data=new FormData;data.append("file",e);var n=new XMLHttpRequest;n.addEventListener("readystatechange",(function(){4===this.readyState&&(console.log("uploadFileRequest responseText",this.responseText),l(this.responseText))}));let c="http://api.jianpiane.com";c+="/upload/slice",c+="?md5="+t.md5,c+="&size="+t.size,c+="&type="+t.type,c+="&ext="+t.ext,c+="&step="+t.step,c+="&chunks="+t.chunks,console.log("uploadFileRequest url",c),n.open("POST",c),n.send(data)}))},created:function(){console.log("uploader created")},mounted:function(){console.log("uploader mounted");let e=this,t=this.id;console.log("uploaderId:",t),document.getElementById(t).addEventListener("change",(async function(){let t=this.files[0];console.log(t),e.fileObject=t;let l=e.checkFileType(t);if(console.log("checkFileType ret: ",l),!l)return!1;try{let l=await e.readFileMd5(t);e.fileMd5=l,await e.getFileUploadedInfo(l)}catch(e){this.$alert("校验文件失败")}}))}},d=l(2);var h={components:{Uploader:Object(d.a)(r,(function(){var e=this,t=e.$createElement,l=e._self._c||t;return l("div",[l("el-button",{attrs:{type:"primary"},on:{click:e.chooseFile}},[e._v("选择文件")]),e._ssrNode(' <input type="file" name="video"'+e._ssrAttr("id",e.id)+' style="display:none;"> <div class="mt-2"><span class="text-black">'+e._ssrEscape(e._s(e.fileObject.name))+"</span> "+(e.currentChunk!=e.chunks?'<div class="mt-2 text-gray-600"><span>'+e._ssrEscape("文件校验中 "+e._s(e.fileMd5CheckProcess)+" ...")+"</span></div>":"\x3c!----\x3e")+" "+(e.fileMd5?'<div class="mt-2 text-gray-600"><span>'+e._ssrEscape("\n        校验成功, 文件hash:"+e._s(e.fileMd5)+",\n        ")+(e.uploadStep<e.chunks?'<a class="text-blue-500 cursor-pointer">确认上传</a>':"<span>上传成功</span>")+"</span></div>":"\x3c!----\x3e")+" "+(e.isUploading?'<div class="mt-2 text-gray-600">'+e._ssrEscape("上传中, 完成 "+e._s(e.uploadStep)+" / "+e._s(e.chunks)+" ...")+"</div>":"\x3c!----\x3e")+" "+(e.uploadError?'<div class="mt-2 text-red-600">'+e._ssrEscape(e._s(e.uploadError))+"</div>":"\x3c!----\x3e")+"</div>")],2)}),[],!1,(function(e){}),null,"4708691e").exports},async fetch({store:e,params:t}){},methods:{}};var f=Object(d.a)(h,(function(){var e=this.$createElement;return(this._self._c||e)("div",{},[this._ssrNode('<h3 class="text-3xl">欢迎使用</h3>')])}),[],!1,(function(e){}),null,"5e09c97e");t.default=f.exports}};